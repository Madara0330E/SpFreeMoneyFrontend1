<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors https://spworlds.ru;">
    <title>–°–±–æ—Ä—ã</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f0f0f;
            color: #fff;
            margin: 0;
            padding: 1rem;
        }
        .campaign {
            display: flex;
            gap: 1rem;
            background: #1c1c1c;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.05);
        }
        .campaign img {
            width: 64px;
            height: 64px;
            border-radius: 8px;
        }
        .campaign-info {
            flex: 1;
        }
        .title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.2rem;
        }
        .description {
            margin-bottom: 0.4rem;
        }
        .amounts {
            font-weight: bold;
            color: #0f0;
        }
        .donate-button {
            background: #0f0;
            border: none;
            color: #000;
            padding: 0.5rem 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        .donate-button:hover {
            background: #0c0;
        }
    </style>
</head>
<body>
<h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–±–æ—Ä—ã</h2>
<div id="campaignList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<script type="module">
    import SPWMini from 'https://cdn.jsdelivr.net/npm/spwmini/client/+esm';

    const spm = new SPWMini('d677f363-a968-4989-8753-ae52757de598');
    let authToken = ''; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

    spm.on('initResponse', async (user) => {
        const campaignsEl = document.getElementById('campaignList');
        campaignsEl.innerText = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...';

        try {
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
            const authRes = await fetch('https://money.chasman.engineer/api/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    accountId: user.accountId ?? '',
                    discordId: user.discordId ?? '',
                    minecraftUUID: user.minecraftUUID,
                    username: user.username,
                    hash: user.hash
                })
            });

            const authData = await authRes.json();
            authToken = authData.authToken; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω

            if (!authToken) {
                campaignsEl.innerText = '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.';
                return;
            }

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π
            campaignsEl.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–±–æ—Ä–æ–≤...';

            const campaignRes = await fetch('https://money.chasman.engineer/api/campaigns', {
                headers: {
                    'Authorization': `${authToken}` // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                }
            });

            const data = await campaignRes.json();

            if (!data.campaigns || data.campaigns.length === 0) {
                campaignsEl.innerHTML = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–±–æ—Ä–æ–≤.';
                return;
            }

            campaignsEl.innerHTML = '';
            data.campaigns.forEach(c => {
                const el = document.createElement('div');
                el.className = 'campaign';
                el.innerHTML = `
                    <img src="${c.owner.avatarUrl}" alt="–∞–≤–∞—Ç–∞—Ä">
                    <div class="campaign-info">
                        <div class="title">${c.title}</div>
                        <div class="description">${c.description}</div>
                        <div class="amounts">–°–æ–±—Ä–∞–Ω–æ ${c.currentAmount} / ${c.targetAmount}</div>
                        <div class="description">–ê–≤—Ç–æ—Ä: ${c.owner.username}</div>
                        <button class="donate-button" data-id="${c.id}">üí∞ –ü–æ–º–æ—á—å 10 –º–æ–Ω–µ—Ç</button>
                    </div>
                `;

                el.querySelector('.donate-button').addEventListener('click', async () => {
                    try {
                        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è —Å —Ç–æ–∫–µ–Ω–æ–º
                        const res = await fetch(`https://money.chasman.engineer/api/campaigns/${c.id}/donate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `${authToken}` // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                            },
                            body: JSON.stringify({
                                amount: 10,
                                comment: "–£–¥–∞—á–∏!",
                                isAnonymous: true
                            })
                        });

                        if (res.ok) {
                            const donationData = await res.json();
                            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞
                            const paymentCode = donationData.donate.code;
                            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ SPWMini
                            spm.openPayment(paymentCode);
                        } else {
                            const err = await res.text();
                            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–æ—â–∏: ${err}`);
                        }
                    } catch (e) {
                        console.error(e);
                        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è.");
                    }
                });

                campaignsEl.appendChild(el);
            });
        } catch (e) {
            campaignsEl.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ.';
            console.error(e);
        }
    });

    spm.on('initError', err => {
        document.getElementById('campaignList').innerText = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + err;
    });
</script>
</body>
</html>
